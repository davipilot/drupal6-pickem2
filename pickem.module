<?php
// $Id: pickem.module,v 1.1.2.4 2008/09/22 18:20:32 jvandervort Exp $

/**
 * @file
 * pickem module allows you to run a pickem league.
*/
 
$tz = variable_get('pickem_time_zone', 'TZ=US/Eastern');
putenv($tz);

require_once 'pickem.inc';

$_pickem_my_leagues = array();

/**
 * Implementation of hook_help().
 */
 function pickem_help($section = "") {
  switch ($section) {
    case 'admin/modules#description' :
      return t("A drupal module for sports pickem style board.");
    case 'admin/content/pickem':
      return '<p>'. t('Here is where you administer all pickem leagues.  Use the tabs above to perform various league functions.<br/>Each pickem user can belong to multiple leagues and will have separate pick sets per league.<br/>All Leagues share the same games currently (same DB table).  You\'ll need to run a separate site if you want to run different game sets at the same time.') .'</p>';
    case 'admin/content/pickem/leagues':
      return '<p>'. t('Here is where you add/edit leagues.  If you need a chat forum and the selection box is empty, enable forums and create a forum.') .'</p>';
    case 'admin/content/pickem/league_users':
      return '<p>'. t('A league is a group of users who compete against each other.  Choose a league and then proceed to its user list.') .'</p>';
    case 'admin/content/pickem/picks':
      return '<p>'. t('Here is where you can override a users picks at the descretion of the commisioner (special circumstances) Choose a league then choose a user and then proceed to the pickset.') .'</p>';
    case 'admin/content/pickem/scores':
      return '<p>'. t('After each game/week, enter the scores here.') .'</p>';
    case 'admin/content/pickem/teams':
      return '<p>'. t('In most lists the abbrev is used first, but if empty, the name is used.') .'</p>';
    case 'admin/content/pickem/games':
      return '<p>'. t('In order to add games, you need to have weeks and teams already entered.<br/>All fields are required.<br/>Note the pager on the bottom to navigate weeks.') .'</p>';
    case 'admin/content/pickem/weeks':
      return '<p>'. t('Weeks are numbered sequentially, starting at 1.  First Game Time is the field that locks users from changing their picks.  Make sure to fill that one out.<br/>Typical values for NFL would be 1, Week 1, WK1, 2008-11-12 12:00:00, 1') .'</p>';
  }
}

/*
 * Implementation of hook_init().
*/
function pickem_init() {
  //drupal_set_message('pickem_init');
  
  // fix menus when they crash in the middle
  //menu_rebuild();  
  
  global $_pickem_my_leagues;
  $_pickem_my_leagues = get_my_leagues();
  
  $stylesheet = drupal_get_path('theme', $GLOBALS['theme_key'] .'/pickem.css');
  if (!file_exists($stylesheet)) {
    $stylesheet = drupal_get_path('module', 'pickem') .'/pickem.css';
  }
  drupal_add_css($stylesheet);
}

/*
 * Implementation of hook_menu().
*/
function pickem_menu() {
  global $user;
  global $_pickem_my_leagues;

  $items = array();

  $items['pickem'] = array(
    'title' => t('Pickem Leagues'), 
    'page callback' => 'league_router', 
    'access arguments' => array('play pickem'), 
    'type' => MENU_NORMAL_ITEM,
    'weight' => -10,
  );

  $items['pickem/%league'] = array(
    'page callback' => 'page_league', 
    'page arguments' => array(1),
    'access arguments' => array('play pickem'),
    'type' => MENU_CALLBACK,
  );

  // arg1 is league id
  $items['pickem/%league/mypicks'] = array(
    'page callback' => 'page_mypicks_all', 
    'page arguments' => array(1),
    'access arguments' => array('play pickem'),
    'type' => MENU_CALLBACK,
  );


  // arg1 is league id, arg2 is weeknum
  $items['pickem/%league/mypicks/%'] = array(
    'page callback' => 'page_mypicks_week', 
    'page arguments' => array(1, 3),
    'access arguments' => array('play pickem'),
    'type' => MENU_CALLBACK,
  );

  $items['pickem/%league/standings'] = array(
    'page callback' => 'page_standings', 
    'page arguments' => array(1),
    'access arguments' => array('play pickem'),
    'type' => MENU_CALLBACK,
  );

  $items['pickem/%league/weeklypicks/%'] = array(
    'title' => t('This Weeks Pick List'), 
    'page callback' => 'page_weeklypicks', 
    'page arguments' => array(1, 3),
    'access arguments' => array('play pickem'),
    'type' => MENU_CALLBACK,
  );

  if ( variable_get('pickem_partial_league', 0) == 0 ) {
    $items['pickem/%league/grid'] = array(
      'title' => t('Schedule Grid'), 
      'page callback' => 'page_grid', 
      'page arguments' => array(1),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );
  }


  if (module_exists("open_flash_chart_api")) {
    // arg1 is league id
    $items['pickem/%league/chart1'] = array(
      'title' => t('Weekly High/Low Chart'), 
      'page callback' => 'chart1', 
      'page arguments' => array(1),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );
    // arg1 is league id
    $items['pickem/%league/chart1/%user'] = array(
      'title' => t('Weekly High/Low Chart'), 
      'page callback' => 'chart1', 
      'page arguments' => array(1, 3),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );
  
    if ( variable_get('pickem_partial_league', 0) == 0 ) {
      $items['pickem/%league/chart2'] = array(
        'title' => t('Team Pickability'), 
        'page callback' => 'chart2', 
        'page arguments' => array(1),
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
      );
      $items['pickem/%league/chart2/%'] = array(
        'title' => t('Team Pickability'), 
        'page callback' => 'chart2', 
        'page arguments' => array(1, 3),
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
      );
    }
    }

  // dynamic logo
  $items['pickem/logos.gif'] = array(
    'title' => t('Team Logo'), 
    'page callback' => 'stream_logo', 
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,    
  );

  $items['pickem/%league/team_stats'] = array(
    'title' => t('Team Stats'), 
    'page callback' => 'page_team_stats', 
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,    
  );




  //
  //
  //admin menus, 'file' => 'pickem_admin.inc',
  //
  //
  $items['admin/content/pickem'] = array(
    'title' => t('Pickem Leagues'),
    'description' => t('Run your own pickem league(s)'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pickem_admin_settings'),
    'access arguments' => array('administer pickem'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'pickem_admin.inc',
  );    

  $items['admin/content/pickem/leagues'] = array(
    'title' => t('Leagues'), 
    'page callback' => 'page_admin_leagues', 
    'access arguments' => array('administer pickem'),
    'weight' => 1,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );

  $items['admin/content/pickem/league_users'] = array(
    'title' => t('League Users'), 
    'page callback' => 'page_admin_leagues_users', 
    'access arguments' => array('administer pickem'),
    'weight' => 2,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );

  $items['admin/content/pickem/league_users/%league'] = array(
    'title' => t('League User Admin'), 
    'page callback' => 'page_admin_league_users', 
    'page arguments' => array(4),
    'access arguments' => array('administer pickem'),
    'weight' => 2,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );
  
  $items['admin/content/pickem/picks'] = array(
    'title' => t('Picks'), 
    'page callback' => 'page_admin_picks', 
    'access arguments' => array('administer pickem'),
    'weight' => 3,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );
  $items['admin/content/pickem/games'] = array(
    'title' => t('Games'), 
    'page callback' => 'page_admin_games', 
    'access arguments' => array('administer pickem'),
    'weight' => 4,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );
  $items['admin/content/pickem/scores'] = array(
    'title' => t('Scores'), 
    'page callback' => 'page_admin_scores', 
    'access arguments' => array('administer pickem'),
    'weight' => 5,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );
  $items['admin/content/pickem/weeks'] = array(
    'title' => t('Weeks'), 
    'page callback' => 'page_admin_weeks', 
    'access arguments' => array('administer pickem'),
    'weight' => 6,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );
  $items['admin/content/pickem/teams'] = array(
    'title' => t('Teams'), 
    'page callback' => 'page_admin_teams', 
    'access arguments' => array('administer pickem'),
    'weight' => 7,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );
  $items['admin/content/pickem/email_league'] = array(
    'title' => t('Email League'), 
    'page callback' => 'page_admin_email_league', 
    'access arguments' => array('administer pickem'),
    'weight' => 8,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );

  $items['admin/content/pickem/import'] = array(
    'title' => t('Import Data'), 
    'page callback' => 'page_admin_data_import', 
    'access arguments' => array('administer pickem'),
    'weight' => 9,
    'file' => 'pickem_admin.inc',
    'type' => MENU_LOCAL_TASK, 
  );
  
  return $items;
}
 
/**
 * Implementation of hook_user().
 */
function pickem_user($op, &$edit, &$account, $category = NULL) {
  switch ($op) {
    case 'insert':
      // a new user is being added; add them to the default league
      $auto_signup = variable_get('pickem_auto_signup_enable', 0);
      $default_league = variable_get('pickem_auto_signup_default_league', 0);
      if (  $auto_signup == 1 && $default_league != 0 ) {
        $query = "insert into {pickem_users} (uid, lid) values(%d, %d)";
        $result = db_query($query, $account->uid, $default_league);
        drupal_set_message($account->name .' added to default pickem league.');
      }
      $edit['pickem_user_email_reminders'] = variable_get('pickem_default_email_reminders', 1);
    break;
    case 'form':
      if ( $category == 'account') {
        $form['pickem'] = array('#type' => 'fieldset',
          '#title' => t('Pickem settings'),
          '#weight' => 5,
          '#collapsible' => TRUE,
        );

        $leagues = get_my_leagues();
        $options = array();
        foreach ($leagues as $l) {
          $options[$l->lid] = $l->name; 
        }

        $form['pickem']['pickem_user_default_league'] = array(
          '#type' => 'select',
          '#title' => t('Default League'),
          '#default_value' => !empty($edit['pickem_user_default_league']) ? $edit['pickem_user_default_league'] : FALSE,
          '#description' => t('Show this league by default.'),
          '#options' => $options,
        );
        
        $form['pickem']['pickem_user_email_reminders'] = array(
          '#type' => 'checkbox',
          '#title' => t('Receive email reminders'),
          '#default_value' => !empty($edit['pickem_user_email_reminders']) ? $edit['pickem_user_email_reminders'] : FALSE,
          '#description' => t('Enable email reminders to be sent to you if you have not picked the current weeks games.'),
        );
        return $form;
      }
    break;
  }
}

/**
 * Implementation of hook_perm().
 */
function pickem_perm() {
  return array(
    'administer pickem',
    'play pickem'
  );
}

/**
 * Implementation of hook_cron().
 */
function pickem_cron() {
  $row = db_fetch_object(db_query("SELECT pw.wid,pw.wk_firstgame, UNIX_TIMESTAMP(pw.wk_firstgame) - UNIX_TIMESTAMP(CURDATE()) as diff FROM {pickem_weeks} pw where wk_firstgame > CURDATE() order by wk_firstgame"));
  $wid = $row->wid;
  $days = ($row->diff) / 86400; #days
  $firstgame = $row->wk_firstgame;

  if ($days <= 2 && $days > 0) {
    $query = 'select pu.lid, u.uid, u.mail, u.name, count(pp.pid) picks, count(pg.gid) games, pg.wid from {users} u inner join {pickem_users} pu on pu.uid=u.uid left outer join {pickem_picks} pp on pp.uid=u.uid and pp.lid=pu.lid right outer join {pickem_games} pg on pg.gid=pp.gid where pg.wid=%d group by pu.lid, u.uid, u.mail, u.name';
    $result = db_query($query, $wid);
    while ($row = db_fetch_object($result)) {
      $missing_count = $row->games - $row->picks;
      if ( $missing_count > 0 ) {
        $user = user_load($row->uid);
        if ( $user->pickem_user_email_reminders == 1 ) {
          email_warning($user, $row->wid, $firstgame, $missing_count, $row->lid);
        }
      }      
    }
  }
}




/**
 * Implementation of hook_theme()
 */
function pickem_theme() {
  return array(
    'admin_leagues_form' => array(
      'file' => 'pickem_admin.inc',
      'arguments' => array('form' => NULL),
    ),
    'admin_teams_form' => array(
      'file' => 'pickem_admin.inc',
      'arguments' => array('form' => NULL),
    ),
    'admin_weeks_form' => array(
      'file' => 'pickem_admin.inc',
      'arguments' => array('form' => NULL),
    ),
    'admin_games_form' => array(
      'file' => 'pickem_admin.inc',
      'arguments' => array('form' => NULL),
    ),
    'league_nav' => array(
      'arguments' => array('league' => NULL),
    ),
    'my_league_summary' => array(
      'arguments' => array('league' => NULL),
    ),
    'league_messages' => array(
      'arguments' => array('league' => NULL),
    ),
    'leaderboard_block' => array(
      'arguments' => array('league_id' => NULL),
    ),
    'this_weeks_games_block' => array(
      'arguments' => array('league_id' => NULL),
    ),
    'this_weeks_games_scrape' => array(
      'arguments' => array(),
    ),
    'dash' => array(
      'arguments' => array('title' => NULL, 'content' => NULL, 'region' => 'main', 'link' => NULL, ),
    ),
    'team_stats' => array(
      'arguments' => array(),
    ),
  );
}


/* 
 * Menu Callbacks
 */
function page_grid($league) {
  drupal_set_title("NFL Schedule Grid");

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);

  $output = '';
  
  if ( ($cache = cache_get('pickem_grid_scores')) && !empty($cache->data)) {
    drupal_add_js('misc/tableheader.js');
    $output = unserialize($cache->data);
  } 
  else {
    $weeks = get_weeks(0, 'regular'); // skip playoffs, no room on screen
    
    $header = array('&nbsp;');
    foreach ($weeks as $w => $w_data) {
      $header[] = array('data' => $w, 'title' => 'Week Number '. $w);
    }
  
    $query = "SELECT g.gid, g.wid, h.tm_abbrev as home, v.tm_abbrev as visitor, g.h_score, g.v_score FROM {pickem_games} g inner join {pickem_teams} h on h.tid=g.h_id inner join {pickem_teams} v on v.tid=g.v_id order by wid";
    $result = db_query($query);
  
    $games = array();
    while ($row = db_fetch_object($result)) {
      if ($row->h_score > $row->v_score) {
        // Home Victory
        $games[$row->home][$row->wid] = array(
          "op" => $row->visitor,
          "w-l" => "win",
          "h-a" => "home",
          "score" => $row->h_score .'-'. $row->v_score
        );
        $games[$row->visitor][$row->wid] = array(
          "op" => $row->home,
          "w-l" => "loss",
          "h-a" => "away",
          "score" => $row->v_score .'-'. $row->h_score
        );
      }
      elseif ($row->v_score > $row->h_score) {
        // Visitor Victory
        $games[$row->home][$row->wid] = array(
          "op" => $row->visitor,
          "w-l" => "loss",
          "h-a" => "home",
          "score" => $row->h_score .'-'. $row->v_score
        );
        $games[$row->visitor][$row->wid] = array(
          "op" => $row->home,
          "w-l" => "win",
          "h-a" => "away",
          "score" => $row->v_score .'-'. $row->h_score
        );
      }
      elseif ($row->v_score == $row->h_score && $row->h_score <> "") {
        // TIE
        $games[$row->home][$row->wid] = array(
          "op" => $row->visitor,
          "w-l" => "tie",
          "h-a" => "home",
          "score" => $row->h_score .'-'. $row->v_score
        );
        $games[$row->visitor][$row->wid] = array(
          "op" => $row->home,
          "w-l" => "tie",
          "h-a" => "away",
          "score" => $row->v_score .'-'. $row->h_score
        );
      } 
      else {
        // TBD, game not played  
        $games[$row->home][$row->wid] = array(
          "op" => $row->visitor,
          "w-l" => "tbd",
          "h-a" => "home",
          "score" => 'N/A'
        );
        $games[$row->visitor][$row->wid] = array(
          "op" => $row->home,
          "w-l" => "tbd",
          "h-a" => "away",
          "score" => 'N/A'
        );
      }
    }
    ksort($games);
  
  
    $output = '<div class="pickem">Hover over completed game for the score.';
    
    $rows = array();
    foreach ($games as $tm => $teamsgames) {
      ksort($teamsgames);
      $row = array();
      $row[] = array('data' => $tm, 'class' => 'team_head');
      foreach ($weeks as $w => $w_data) {
        if (isset ($teamsgames[$w])) {
          $class .= $teamsgames[$w]["h-a"];
          $class .= " ". $teamsgames[$w]["w-l"];
          if ($teamsgames[$w]["h-a"] == "away") {
            $teamsgames[$w]["op"] = '@'. $teamsgames[$w]["op"];
          }
          $row[] = array('data' => $teamsgames[$w]["op"], 'class' => $teamsgames[$w]["w-l"], 'title' => strtoupper($teamsgames[$w]["w-l"]) .' '. $teamsgames[$w]["score"]);
        } 
        else {
          if ($w_data->playoffs == 1) {
            // playoffs, blank, used for teams that didn't make the playoffs
            $row[] = '&nbsp;';
          } 
          else {
            // bye week
            $row[] = array('data' => 'bye', 'class' => 'bye', 'title' => 'Bye Week');
          }
        }
      }
      $rows[] = $row;
    }
    
    $output .= theme('table', $header, $rows, array('class' => 'grid'));    
    
//    $output .= '<table class="grid">';
//    $output .= '<tr><th class="legend-desc">Legend</th></tr>';
//    $output .= '<tr><td class="win">CLE</td><td class="legend-desc">Win (for team in the first column)</td></tr>';
//    $output .= '<tr><td class="loss">DAL</td><td class="legend-desc">Loss (for team in the first column)</td></tr>';
//    $output .= '<tr><td class="tie">SEA</td><td class="legend-desc">Tie</td></tr>';
//    $output .= '<tr><td class="tbd">DEN</td><td class="legend-desc">Not Yet Played</td></tr>';
//    $output .= '<tr><td class="bye">bye</td><td class="legend-desc">Bye</td></tr>';
//  
    
    $output .= '</div>';

    cache_set('pickem_grid_scores', serialize($output));
  }


  print theme('page', $output);
}

function page_mypicks_week($league, $week_num='') {
  //drupal_set_message('page_mypicks_week');

  global $_pickem_my_leagues;
  global $user;
  
  $flip = array('even' => 'odd', 'odd' => 'even');
  $class = 'even';
  
  $week = get_weeks($week_num, 'regular');
  
  //POSTING, save picks
  if (count($_POST) > 0) {
    if ($week[$week_num]['week_past'] == 1) {
      drupal_set_title($week[$week_num]['name'] .' picks are locked.');
      print theme('page', "You cannot change your picks now.");
      return;
    }

    $type = "";
    if ( isset($_POST['apply_to_all_my_leagues'] ) ) {
      unset($_POST['apply_to_all_my_leagues']);
      foreach ($_pickem_my_leagues as $l) {
        foreach ($_POST as $gid => $pick) {
          $gid = preg_split('/_/', $gid);
          set_pick($gid[1], $user->uid, $l->lid, $pick);
        }
      }
      drupal_set_message("Picks: saved for all leagues");
      watchdog('pickem', 'Picks saved(all) for <i>'. $user->name .'</i>, week '. $week_num .'.');

    } 
    else {
      foreach ($_POST as $gid => $pick) {
        $gid = preg_split('/_/', $gid);
        set_pick($gid[1], $user->uid, $league->lid, $pick);
      }
      drupal_set_message("Picks: saved");
      watchdog('pickem', 'Picks saved for <i>'. $user->name .'</i>, week '. $week_num .'.');
    }
  }

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);

  // SINGLE WEEK VIEW
  $teams = get_teams();
  if (is_numeric($week_num)) {
    drupal_set_title("Week $week_num Picks - ". $user->name);
    $query = "SELECT g.gid, g.wid, g.h_score, g.v_score, g.v_id, g.v_spread, g.h_id, g.h_spread, pp.winnerpick_id, g.gametime FROM {pickem_games} g LEFT OUTER JOIN {pickem_picks} pp ON pp.gid = g.gid and pp.uid=%d and pp.lid=%d where g.wid=%d ORDER BY g.wid, g.gametime, g.gid";
    $result = db_query($query, $user->uid, $league->lid, $week_num);
    $games = array();
    while ($row = db_fetch_object($result)) {
      $games[$row->wid][$row->gid] = array(
        "hid" => $row->h_id,
        "h_spread" => $row->h_spread,
        "vid" => $row->v_id,
        "v_spread" => $row->v_spread,
        "pick" => $row->winnerpick_id,
        "gametime" => $row->gametime
      );
    }
    $output = '<div class="pickem"><form action="" method="post"><table class="picks">';
    if ($league->scoring_type == 0) {
      $output .= "<tr><th>Visitor</th><th>Home</th><th>Game Time(EST)</th></tr>";
    } 
    else if ($league->scoring_type == 1) {
      $output .= "<tr><th>Visitor</th><th>VSpread</th><th>Home</th><th>HSpread</th><th>Game Time(EST)</th></tr>";
    }
    foreach ($games as $wid => $weeksgames) {
      foreach ($weeksgames as $gid => $game) {
        $v_sel = "";
        $h_sel = "";
        if ($game["pick"] == $game["vid"]) {
          $v_sel = "checked";
        }
        elseif ($game["pick"] == $game["hid"]) {
          $h_sel = "checked";
        }
        
        if ($week[$week_num]['week_past'] == 0) {
          $output .= '<tr>';
          $output .= '<td><input type="radio" name="gid_'. $gid .'" value="'. $game["vid"] .'" '. $v_sel .'/>'. $teams[$game["vid"]]->tm_abbrev .'</td>';
          if ($league->scoring_type == 1) {
            $output .= '<td>'. $game['v_spread'] .'</td>';
          }
          $output .= '<td><input type="radio" name="gid_'. $gid .'" value="'. $game["hid"] .'" '. $h_sel .'/>'. $teams[$game["hid"]]->tm_abbrev .'</td>';
          if ($league->scoring_type == 1) {
            $output .= '<td>'. $game['h_spread'] .'</td>';  
          }
        } 
        else {
          $output .= '<tr>'; 
          if ($game["pick"] == $game["vid"]) {
            $output .= '<td><input name="checkbox1" type="checkbox" value="checkbox" onclick="return false" checked/>'. $teams[$game["vid"]]->tm_abbrev .'</td>';
            if ($league->scoring_type == 1) {
              $output .= '<td>'. $game['v_spread'] .'</td>';  
            }
          } 
          else {
            $output .= '<td>'. $teams[$game["vid"]]->tm_abbrev .'</td>';
            if ($league->scoring_type == 1) {
              $output .= '<td>'. $game['v_spread'] .'</td>';  
            }
          }

          if ($game["pick"] == $game["hid"]) {
            $output .= '<td><input name="checkbox1" type="checkbox" value="checkbox" onclick="return false" checked/>'. $teams[$game["hid"]]->tm_abbrev .'</td>';
            if ($league->scoring_type == 1) {
              $output .= '<td>'. $game['h_spread'] .'</td>';  
            }
          } 
          else {
            $output .= '<td>'. $teams[$game["hid"]]->tm_abbrev .'</td>';
            if ($league->scoring_type == 1) {
              $output .= '<td>'. $game['h_spread'] .'</td>';  
            }
          }
        }
        if (isset ($game["pick"])) {
          $output .= '<td class="pick">'. $game['gametime'] .'</td></tr>';
        } 
        else {
          $output .= '<td class="nopick">'. $game['gametime'] .'</td></tr>';
        }
      }
    }
    $output .= '</table>';
    
    if ($week[$week_num]['week_past'] == 0 ) {
      if ( count($_pickem_my_leagues) > 1 ) {
        $output .= '<input type="checkbox" name="apply_to_all_my_leagues">Apply picks to all my leagues<br/><br/>';
      }
      $output .= '<input type="submit" value="Save Picks"/>';
    }
    $output .= '</form></div>';
  } 

  print theme('page', $output);
}

function page_mypicks_all($league) {
  global $_pickem_my_leagues;
  global $user;

  drupal_set_title("My Picks - ". $user->name);

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);
  
  $flip = array('even' => 'odd', 'odd' => 'even');
  $class = 'even';
  
  $teams = get_teams();

  // SHOW ALL WEEKS VIEW
  $games = array();

  // two parts query so current week is always ontop, and passed weeks are at the bottom.
  $mysqltime = date("Y-m-d H:i:s");
  $query = "select g.gid, g.wid, g.h_score, g.v_score, g.v_id, g.h_id, pp.winnerpick_id, g.gametime from {pickem_games} g inner join {pickem_weeks} w on w.wid=g.wid left outer join {pickem_picks} pp on pp.gid = g.gid and pp.uid=%d and pp.lid=%d where w.wk_firstgame > '". $mysqltime ."' order by g.wid, g.gametime, g.gid";
  $result = db_query($query, $user->uid, $league->lid);
  while ($row = db_fetch_object($result)) {
    $games[$row->wid][$row->gid] = array(
      "hid" => $row->h_id,
      "vid" => $row->v_id,
      "pick" => $row->winnerpick_id,
      "vscore" => $row->v_score,
      "hscore" => $row->h_score,
      "gametime" => $row->gametime
    );
  }
  
  $query = "select g.gid, g.wid, g.h_score, g.v_score, g.v_id, g.h_id, pp.winnerpick_id, g.gametime from {pickem_games} g inner join {pickem_weeks} w on w.wid=g.wid left outer join {pickem_picks} pp on pp.gid = g.gid and pp.uid=%d and pp.lid=%d where w.wk_firstgame < '". $mysqltime ."' order by g.wid, g.gametime, g.gid";
  $result = db_query($query, $user->uid, $league->lid);
  while ($row = db_fetch_object($result)) {
    $games[$row->wid][$row->gid] = array(
      "hid" => $row->h_id,
      "vid" => $row->v_id,
      "pick" => $row->winnerpick_id,
      "vscore" => $row->v_score,
      "hscore" => $row->h_score,
      "gametime" => $row->gametime
    );
  }

  $output = '<div class="pickem">Click on week number to make picks.<table class="picks">';
  foreach ($games as $wid => $weeksgames) {
    $class = $flip[$class];      
    $output .= '<tr class="'. $class .'"><th>'. l("$wid", "pickem/$league->lid/mypicks/$wid") .'</th><td>';
    foreach ($weeksgames as $gid => $game) {
      $v_team = ($teams[$game["vid"]]->tm_abbrev <> '')?$teams[$game["vid"]]->tm_abbrev:$teams[$game["vid"]]->tm_name;
      $h_team = ($teams[$game["hid"]]->tm_abbrev <> '')?$teams[$game["hid"]]->tm_abbrev:$teams[$game["hid"]]->tm_name;
      $output .= '<div class="picks-float">';
      if (isset ($teams[$game["pick"]]->tm_abbrev)) {
        if ($game["pick"] == $game["vid"] && $game["vscore"] > $game["hscore"]) {
          $output .= '<span class="pick_win">'. $v_team .'</span><br/>@'. $h_team;
        }
        elseif ($game["pick"] == $game["hid"] && $game["hscore"] > $game["vscore"]) {
          $output .= $v_team .'<br/>@<span class="pick_win">'. $h_team .'</span>';
        }
        elseif ($game["hscore"] <> "" && $game["hscore"] == $game["vscore"]) {
          $output .= '<span class="pick_win">'. $v_team .'<br/>@'. $h_team .'</span>';
          
        }
        elseif ($game["pick"] == $game["vid"] && $game["vscore"] < $game["hscore"]) {
          $output .= '<span class="pick_loss">'. $v_team .'</span><br/>@'. $h_team;
        }
        elseif ($game["pick"] == $game["hid"] && $game["hscore"] < $game["vscore"]) {
          $output .= $v_team .'<br/>@<span class="pick_loss">'. $h_team .'</span>';
        }
        elseif ($game["pick"] == $game["hid"]) {
          $output .= $v_team .'<br/>@<b>'. $h_team .'</b>';
        }
        elseif ($game["pick"] == $game["vid"]) {
          $output .= '<b>'. $v_team .'</b><br/>@'. $h_team;
        }
      } 
      else {
        $output .= $v_team .'<br/>@'. $h_team;
      }
      $output .= "</div>";
    }
    $output .= "</td></tr>";
  }
  $output .= "</table></div>";
  
  print theme('page', $output);
}

function page_weeklypicks($league, $week_id) {
  global $user;

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);

  $flip = array('even' => 'odd', 'odd' => 'even');
  $class = 'even';

  $week = get_weeks($week_id, 'regular');
  
  $output = '<div class="pickem">Sorted by this week\'s scores<table><tr><th>&nbsp;</th>';
  $gids = array();
  $teams = get_teams();
  $games = get_games($week_id);
  foreach ($games as $gid => $g_data) {
    $output .= '<th>'. $teams[$g_data->v_id]->tm_abbrev ."<br/>@". $teams[$g_data->h_id]->tm_abbrev .'</th>';
    if ( $g_data->h_score == NULL ) {
      $gids[$gid] = 0;  // game not played
    }
    elseif ($g_data->h_score == $g_data->v_score) {
      $gids[$gid] = -1; // game ended in tie
    }
    elseif ($g_data->h_score > $g_data->v_score) {
      $gids[$gid] = $g_data->h_id;
    }
    elseif ($g_data->v_score > $g_data->h_score) {
      $gids[$gid] = $g_data->v_id;
    } 
  }
  $output .= '</tr>';
  
  $totals = get_user_totals($league->lid, $week_id); //sorted by overall score
  $gamepicks = get_game_picks($league->lid, $week_id);
  
  foreach ($totals as $uid => $user_totals) {
    $class=$flip[$class];
    $output .= '<tr class="'. $class .'"><td class="users">'. l($user_totals['name'], 'user/'. $uid) .'</td>';
    foreach ($gids as $gid => $winnerid) {
      $p_team = ($teams[$gamepicks[$gid][$uid]]->tm_abbrev <> '')?$teams[$gamepicks[$gid][$uid]]->tm_abbrev:$teams[$gamepicks[$gid][$uid]]->tm_name;
      
      if (isset ($gamepicks[$gid][$uid]) && $gamepicks[$gid][$uid] == $winnerid && $winnerid != 0) {
        $output .= '<td class="win">'. $p_team .'</td>';
      }
      elseif (isset ($gamepicks[$gid][$uid]) && $winnerid == -1) {
        $output .= '<td class="tie">'. $p_team .'</td>';
      }
      elseif (isset ($gamepicks[$gid][$uid]) && $gamepicks[$gid][$uid] != $winnerid && $winnerid != 0) {
        $output .= '<td class="loss">'. $p_team .'</td>';
      } 
      else {
        if ($week[$week_id]['week_past'] == 1 || $uid == $user->uid) {
          $output .= '<td>'. $p_team .'</td>';
        } 
        else {
          if (isset ($gamepicks[$gid][$uid])) {
            $output .= '<td>X</td>';
          } 
          else {
            $output .= '<td>&nbsp;</td>';
          }
        }
      }
    }
    $output .= '</tr>';
  }

  $output .= '</table></div>';

  drupal_set_title($week[$week_id]['name'] .' Pick Summary');
  print theme('page', $output);
}

function page_standings($league) {
  drupal_set_title("Standings");

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);

  drupal_add_js('misc/collapse.js');

  $totals = get_user_totals($league->lid);
  $week_totals = get_totals_by_week($league->lid);
  $weeks = get_weeks(0, 'regular');

  $flip = array('even' => 'odd', 'odd' => 'even');
  $class = 'even';

  $output = '<div class="pickem">Click on week numbers to see weekly pick summary.';
  $output .= '<div><fieldset class="collapsible"><legend><a href="#">Regular Season</a></legend>';
  $output .= '<table class="standings"><tr><th>&nbsp;</th>';

  $wk_summary = array();
  $output .= '<th colspan="2">TOT</th>';
  foreach ($weeks as $w => $w_data) {
    $output .= '<th class="week-numbers">'. l($w, 'pickem/'. $league->lid ."/weeklypicks/$w") .'</th>';
  }
  $output .= "</tr>";

  foreach ($totals as $uid => $u_object) {
    $class = $flip[$class];
    $output .= '<tr class="'. $class .'">';
    $output .= '<th>'. $u_object['ranking'] .'.&nbsp;&nbsp;'. l($u_object['name'], 'user/'. $uid) .'</th>';

    if ($u_object['pts_back'] == 0) {
      $output .= '<td>'. $u_object['total'] .'</td><td>&nbsp;</td>';
      $high = $u_object['total'];
    }
    else {
      $output .= '<td>'. $u_object['total'] .'</td><td>+'. $u_object['pts_back'] .'</td>';
    }
    
    foreach ($weeks as $wid => $w) {
      if ($u_object['weeks'][$wid] == $week_totals[$wid]["min"]) {
        $output .= '<td class="weekly-low">'. $u_object['weeks'][$wid] .'</td>';
      }
      else if ($u_object['weeks'][$wid] == $week_totals[$wid]["max"]) {
        $output .= '<td class="weekly-high">'. $u_object['weeks'][$wid] .'</td>';
      }
      else {
        $output .= '<td>'. $u_object['weeks'][$wid] .'</td>';
      }
    }
    $output .= "</tr>";
  }
  $output .= '</table></fieldset></div>';
  


  //playoff table
  $playoff_weeks = get_weeks(0, 'playoffs');
  $output .= '<div><fieldset class="collapsible"><legend><a href="#">Playoffs</a></legend>';
  $output .= '<table class="standings">';
  
  $output .= '<tr><th>&nbsp;</th><th colspan="2">TOT</th>';
  foreach ($playoff_weeks as $w => $w_data) {
    $output .= '<th class="week-numbers">'. l('Week&nbsp;'. $w .'<br/>'. $w_data['wk_name'], 'pickem/'. $league->lid ."/weeklypicks/$w", array('html' => TRUE)) .'</th>';
  }
  $output .= "</tr>";
  foreach ($totals as $uid => $u) {
    $class = $flip[$class];
    $output .= '<tr class="'. $class .'">';
    $output .= '<th>'. $u['ranking'] .'.&nbsp;&nbsp;'. l($u['name'], 'user/'. $uid) .'</th>';

    if ($u['pts_back'] == 0) {
      $output .= '<td>'. $u['total'] .'</td><td>&nbsp;</td>';
      $high = $u['total'];
    }
    else {
      $output .= '<td>'. $u['total'] .'</td><td>+'. $u['pts_back'] .'</td>';
    }
    foreach ($playoff_weeks as $wid => $w) {
      if ($u['weeks'][$wid] == $week_totals[$wid]["min"]) {
        $output .= '<td class="weekly-low">'. $u['weeks'][$wid] .'</td>';
      }
      else if ($u['weeks'][$wid] == $week_totals[$wid]["max"]) {
        $output .= '<td class="weekly-high">'. $u['weeks'][$wid] .'</td>';
      }
      else {
        $output .= '<td>'. $u['weeks'][$wid] .'</td>';
      }
    }
    $output .= "</tr>";
  }
  $output .= '</table></fieldset></div>';
  
  $output .= '</div>';
  print theme('page', $output);
}


function league_router() {
  global $_pickem_my_leagues;
  global $user;

  if ( isset($user->pickem_user_default_league) ) {
    drupal_goto("pickem/" . $user->pickem_user_default_league);
  }

  if ( count($_pickem_my_leagues) >= 1 ) {
    drupal_goto("pickem/" . $_pickem_my_leagues[0]->lid);
  }

  drupal_set_title("Choose League to View");
  $o = get_all_league_switcher();
  print theme('page', $o); 
}

function page_league($league) {
  drupal_set_title($league->name .' League');

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[1] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);

  $o  = '<div class="pickem"><table class="league-nav"><tr>';
  $o .= '<td class="col1">'. theme('league_nav', $league) .'</td>';
  $o .= '<td class="col2">'. theme('my_league_summary', $league) .'</td>';
  $o .= '</tr>';

  if ( $league->forum_id != 0 ) {
    $o .= '<tr><td colspan="2">'. theme('league_messages', $league) .'</td></tr>';
  }

  if ( variable_get('pickem_use_espn', 0) == 0 ) {
    $o .= '<tr><td colspan="2">'. theme('this_weeks_games') .'</td></tr></table></div>';
  }
  else {
    $o .= '<tr><td colspan="2">'. theme('this_weeks_games_scrape') .'</td></tr></table></div>';
  }


  print theme('page', $o);
}

function theme_league_nav($league) {
    global $user;
    
    $o = '';
    $o .=  '<ul>';
    if ( is_my_league($league) ) {
      $o .= '<li>'. l('My Picks', 'pickem/'. $league->lid .'/mypicks') .'</li>';
    }

    $cur_w = get_current_week(false);
    if ($cur_w['wid'] != '') {
      $o .= '<li>'. l('Pick Summary(week '. $cur_w['wid'] .')', 'pickem/'. $league->lid .'/weeklypicks/'. $cur_w['wid']) .'</li>';
    }

    $o .= '<li>'. l('Standings', 'pickem/'. $league->lid .'/standings') .'</li>';
    
    if ( $league->rules_node_id != 0 ) {
      $o .= '<li>'. l('Rules and Regs', 'node/'. $league->rules_node_id) .'</li>';
    }
    
    if ( $league->forum_id != 0 ) {
      $o .= '<li>'. l('Talk and Taunting', 'forum/'. $league->forum_id) .'</li>';
    }
    
    $o .= '<li>Research<ul>';
    if ( variable_get('pickem_partial_league', 0) == 0 ) {
      $o .= '<li>'. l('Schedule Grid', 'pickem/'. $league->lid .'/grid') .'</li>';
    }
    if (module_exists("open_flash_chart_api")) {
      $o .= '<li>'. l('High/Low Chart', 'pickem/'. $league->lid .'/chart1') .'</li>';
      if ( variable_get('pickem_partial_league', 0) == 0 ) {
        $o .= '<li>'. l('Team Pickability Chart', 'pickem/'. $league->lid .'/chart2') .'</li>';
      }
    }
    $o .= '<li>'. l('Team Win-Loss Stats', 'pickem/'. $league->lid .'/team_stats') .'</li>';

    $o .= '</ul></li></ul>';
    
    return theme('dash', 'Navigation', $o);
}

function theme_my_league_summary($league) {
  //drupal_set_message('theme_my_league_summary');
  global $user;

  $totals = get_user_totals($league->lid); //sorted by overall score
  $title = 'My Summary';
  $content = '<div class="my-league-summary">';
  $content .= 'RANK: #'. $totals[$user->uid]['ranking'] .'<br/>';
  if ( $totals[$user->uid]['ranking'] > 1 ) {
    $content .= 'POINTS BACK: '. $totals[$user->uid]['pts_back'] .'<br/>';
  }
  $content .= 'TOTAL POINTS: '. $totals[$user->uid]['total'] .'<br/>';
  $content .= 'BEST WEEK SCORE:  '. $totals[$user->uid]['weeks'][$totals[$user->uid]['best_week_num']] .' (Week'. $totals[$user->uid]['best_week_num'] .')<br/>';
  $content .= 'WORST WEEK SCORE:  '. $totals[$user->uid]['weeks'][$totals[$user->uid]['worst_week_num']] .' (Week'. $totals[$user->uid]['worst_week_num'] .')<br/>';
  $content .= '</div>';
  return theme('dash', $title, $content);
}


function theme_league_messages($league) {
  global $user;
  
  if ( is_my_league($league) ) {
    $post_link = '/node/add/forum/'. $league->forum_id;
    $output = '<a href="'. $post_link .'">Post new forum topic.</a>';
  }
  $output .= '<ul>';
  $cur_w = get_current_week(true);
  if ( $cur_w['firstgame_date'] != '' ) {
    if ( $cur_w['dow'] <> "Sunday" ) {
      $output .= '<li class="warning">Warning: The first game is on <span style="text-decoration:underline;">'. strtoupper($cur_w['dow']) .'</span>.</li>';
    }
    if (module_exists("countdowntimer")) {
      $output .= '<li class="warning">'. get_countdown_timer($cur_w) .'</span></li>';
    }
  }


  $sql = db_rewrite_sql("SELECT n.nid, n.title, l.comment_count, l.last_comment_timestamp, u.name, c.cid, c.comment, c.subject comment_subject, cu.name comment_name, c.timestamp comment_timestamp FROM {node} n INNER JOIN {node_comment_statistics} l ON n.nid = l.nid inner join {users} u on u.uid=n.uid inner join {term_node} tn on tn.nid=n.nid left outer join {comments} c on c.nid=n.nid left outer join {users} cu on cu.uid=c.uid WHERE n.status = 1 AND n.type = 'forum' and tn.tid=%d ORDER BY GREATEST(n.created, c.timestamp) DESC");
  $result = db_query($sql, $league->forum_id);
  
  $i = 1;
  $content='';
  while ($node = db_fetch_object($result)) {
    if ( $i > 4 ) {
      break;
    }
    $i++;
    if ( $node->comment ) {
      $content .= '<li>'. l($node->comment_subject .' - '. $node->comment_name .' <Re: '. $node->title .'>', 'node/'. $node->nid  )  .  ' ('. format_date($node->comment_timestamp, 'small') .') <a href="/comment/reply/'. $node->nid .'/'. $node->cid .'">-Reply</a></li>';
    } 
    else {
      $content .= '<li>'. l($node->title .' - '. $node->name, 'node/'. $node->nid  )  .' ('. format_date($node->last_comment_timestamp, 'small') .') <a href="/comment/reply/'. $node->nid .'/#comment-form">-Reply</a></li>';
    }
  }
  
  if ( $content == '' ) {
    $content = "<li>None</li>";
  }

  $output .= $content;
  $output .= '</ul>';
  
  return theme('dash', 'Messages', $output);
}

function theme_dash($title, $content, $region='main', $link=NULL) {
  if ( isset($link) ) {
    $output = '<div class="dash"><div class="title">'. $link .'</div><div>'. $content .'</div></div>';
  } 
  else {
    $output = '<div class="dash"><div class="title">'. $title .'</div><div>'. $content .'</div></div>';
  }
  return $output;
} 

function theme_leaderboard_block($league_id) {
  if ( !is_numeric($league_id) ) {
    return '';
  }
  $totals = get_user_totals($league_id); //sorted by overall score
  $content = '<table class="pickem-league-leaders">';
  $how_many = 10;
  $i = 0;
  foreach ($totals as $uid => $totalinfo) {
    $u_name = str_replace(' ', '&nbsp;', $totalinfo['name']);
    $content .= '<tr><td class="score">'. $totalinfo['total'] .'</td><td class="user"><a href="/user/'. $uid .'">'. $u_name .'</a></td></tr>';
    $i++;
    if ( $i >= $how_many ) {
      break;
    }
  }
  $content .= '</table>';
  return $content;
}

function theme_this_weeks_games_block($league_id) {
  $cur_w = get_current_week(false); 
  if ( !is_numeric($league_id) || $cur_w['wid'] == "" ) {
    return '';
  }
  
  $teams = get_teams();
  $games = get_games($cur_w['wid']);
  $picked = get_team_totals($league_id, 'win_lose', $cur_w['wid']);

  $content = '<table class="pickem-weeks-games">';
  foreach ($games as $gid => $row) {
      $v_perc = ($picked[$row->v_id]['picked_perc'] <> '') ? '('. $picked[$row->v_id]['picked_perc'] .'%)' : '';
      $h_perc = ($picked[$row->h_id]['picked_perc'] <> '') ? '('. $picked[$row->h_id]['picked_perc'] .'%)' : '';
      $content .= '<tr><td class="team">'. $teams[$row->v_id]->printing_name . $v_perc . '</td><td class="score">'. $row->v_score .'</td><td class="team">'. $teams[$row->h_id]->printing_name . $h_perc .'</td><td class="score">'. $row->h_score .'</td></tr>';
  }
  $content .= '</table>';
  return $content;
}

function theme_this_weeks_games_scrape($cache_reset = FALSE) {
  // get scores from espn mobile

  // 10 minute cache for the scrape
  if (!$cache_reset && ($cache = cache_get('pickem_games_scrape', 'cache')) && $cache->expire > time() && !empty($cache->data)) {
    $raw = unserialize($cache->data);
  } 
  else {
    $url = "http://mobileapp.espn.go.com/nfl/mp/redesign/scoreboard?markupType=XHTML";
    $useragent="Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.1) Gecko/20061204 Firefox/2.0.0.1";
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_TIMEOUT, 120);
    curl_setopt($ch, CURLOPT_USERAGENT, $useragent);
  
    $raw = curl_exec($ch);
    curl_close($ch);
    cache_set('pickem_games_scrape', serialize($raw), 'cache', time() + (10*60) );
  }

  $pattern = '/<p class="header" ><b>(.*)<\/b><\/p>.*<div class="contentBlock">(.*)<\/div>/sU';
  if ( preg_match($pattern, $raw, $matches) > 0 ) {
    $title = $matches[1];
    $content = $matches[2];
  } 
  else {
    $title = "No Games Found";
    $content = "";    
  }
    
  return theme('dash', $title, $content);
}

function page_team_stats($league) {
  drupal_set_title('Team Stats');
  
  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);
  
  $o  = '<div class="pickem">'. theme('team_stats') .'</div>';
  
  print theme('page', $o);  
}

function theme_team_stats() {
  $teams = get_teams();
  foreach ($teams as $tid => $d) {
    $d->wins = 0;
    $d->losses = 0;
    $d->ties = 0;
    $d->games_played = 0;
    $d->win_percent = 0.0;
    $d->pts_for = 0;
    $d->pts_against = 0;
  }
  
  $games = get_games();
  foreach ($games as $gid => $row) {
    if ( ! isset($row->h_score) || ! isset($row->v_score) ) {
      continue;  
    }
    
    if ( $row->h_score > $row->v_score ) {
      $teams[$row->h_id]->wins++;
      $teams[$row->v_id]->losses++;
    }
    elseif ( $row->h_score < $row->v_score ) {
      $teams[$row->v_id]->wins++;
      $teams[$row->h_id]->losses++;
    }
    elseif ( $row->h_score == $row->v_score ) {
      $teams[$row->v_id]->ties++;
      $teams[$row->h_id]->ties++;
    }
    $teams[$row->h_id]->games_played++;
    $teams[$row->v_id]->games_played++;
    
    $teams[$row->h_id]->win_percent = $teams[$row->h_id]->wins / ( $teams[$row->h_id]->wins + $teams[$row->h_id]->losses );
    $teams[$row->v_id]->win_percent = $teams[$row->v_id]->wins / ( $teams[$row->v_id]->wins + $teams[$row->v_id]->losses );
    
    $teams[$row->v_id]->pts_for += $row->v_score;
    $teams[$row->v_id]->pts_against += $row->h_score;

    $teams[$row->h_id]->pts_for += $row->h_score;
    $teams[$row->h_id]->pts_against += $row->v_score;
    
  }

  // sort
  uasort($teams, "sort_team_stats");
  // render team data

  $rows = array();
  foreach ($teams as $tid => $d) {
    $rows[] = array(
      $teams[$tid]->tm_city .' '. $teams[$tid]->tm_name, 
      array('data' => $teams[$tid]->wins, 'style' => 'width:10px;'), 
      array('data' => $teams[$tid]->losses, 'style' => 'width:10px;'), 
      array('data' => $teams[$tid]->ties, 'style' => 'width:10px;'), 
      sprintf("%.3F", $teams[$tid]->win_percent),

      array('data' => $teams[$tid]->pts_for, 'style' => 'width:10px;'), 
      array('data' => $teams[$tid]->pts_against, 'style' => 'width:10px;'), 
      );
  }
  
  $header = array(t('Team'), t('W'), t('L'), t('T'), t('PCT'), t('PF'), t('PA'));
  
  $o = theme('table', $header, $rows, array('style' => 'width:400px;') );
  
  return $o;
} 

function sort_team_stats($a, $b) {
  if ($a->win_percent > $b->win_percent) {
    return -1;
  } 
  else if ($a->win_percent < $b->win_percent) {
    return 1;
  } 
  else {
   return 0;
  }
}


function stream_logo() {
  header("content-type: image/gif");
  
  $full_path = drupal_get_path('module', 'pickem') .'/nfl_logos';
  $files = array();
  if ( $dir = opendir($full_path) ) {
    while (false !== ($file = readdir($dir))) {
      if (preg_match("/\.gif$/", "$file")) {
        $files[] = $file;
      }

    }
    closedir($dir);
  } 
  print file_get_contents($full_path .'/'. $files[array_rand($files)]);
}


function chart1($league, $user=NULL) {
  drupal_set_title('Charts');

  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);

  $g = new open_flash_chart_api();
  
  if ( isset($user) ) {
    $g->set_title( $user->name .': '. t('Weekly Points High/Low Chart'), '{font-size: 20px;}' );
  } 
  else {
    $g->set_title( t('Weekly Points High/Low Chart'), '{font-size: 20px;}' );
  }
  
  $g->set_width('100%');
  $g->set_height('480');
  
  $weeks = get_totals_by_week($league->lid);

  $b = array();
  foreach ($weeks as $w) {
    if ( $w['count'] == '' ) {
      $b[] = 'null';
    } 
    else {
      $b[] = $w['total'] / $w['count'];
    }
  }
  $g->set_data($b);
  $g->line_dot( 2, 4, '#008000', 'League AVG', 12 );
 
  if ( isset($user) ) {
    $ut = get_user_totals($league->lid);
    $c = array();
    foreach ($weeks as $w) {
      if ( $ut[$user->uid]['weeks'][$w['name']] == '' ) {
        $c[] = 'null';
      } 
      else {
        $c[] = $ut[$user->uid]['weeks'][$w['name']];
      }
    }
    $g->set_data($c);
    $g->line_hollow( 2, 5, '#000080', $ut[$user->uid]['name'], 12 );
  }
 
   $a = array();
  foreach ($weeks as $w) {
    if ( $w['max'] == '' ) {
      $a[] = new candle('null', 'null', 'null', 'null');
    } 
    else {
      $a[] = new candle($w['max'], $w['min'], $w['max'], $w['min']);
    }
  }
  $g->candle( $a, 70, 1, '#800000', 'High/Low', 12 );


  // X axis:
  $weeks = get_weeks(0, 'all');
  $x_labels = array();
  foreach ($weeks as $w => $w_data) {
    $x_labels[] = $w;
  }
  $g->set_x_labels( $x_labels );
  $g->set_x_legend( 'Week', 12);
  
  $g->set_y_max( 16 );
  $g->y_label_steps( 8 );
  $g->set_y_legend( 'Points', 12);
  
  $g->set_bg_colour('0xDFFFDF');
  //echo $g->render();  
  
  $g->set_tool_tip( '#x_legend# #x_label# (#val#)' );

  $o = '<div class="pickem">'. $g->render('js');
  
  $users = get_users($league->lid);
  foreach ($users as $u) {
    $o .= '<span class="user-list-horiz">';
    $name = $u['name'];
    $name = str_replace(' ', '&nbsp;', $name);
    if ( $user->uid == $u['uid'] ) {
      $o .= $name;
    } 
    else {
      $o .= l($name, 'pickem/'. $league->lid .'/chart1/'. $u['uid'], array('html' => TRUE));
    }
    $o .= '</span>';
  }
  $o .= '</div>';
  print theme('page', $o); 
  
}



function chart2($league, $sort_by='win_lose') {
  drupal_set_title('Charts');
  
  $breadcrumb = drupal_get_breadcrumb();
  $breadcrumb[] = l($league->name, 'pickem/'. $league->lid);
  drupal_set_breadcrumb($breadcrumb);
  
  $g = new open_flash_chart_api();
  $g->set_title( t('Team Pickability (Regular Season)'), '{font-size: 20px;}' );
  $g->set_width('100%');
  $g->set_height('480');

  $teams = get_team_totals($league->lid, $sort_by);
  $x_labels = array();
  $a = array();
  foreach ($teams as $tid => $team_data) {
    $a[] = $team_data['pickability'];
    $x_labels[] = $team_data['abbrev'];
  }
  $g->set_data($a);
  $g->area_hollow( 2, 3, 25, '#000080', 'Correctly Picked', 12);

  $a = array();
  foreach ($teams as $tid => $team_data) {
    $a[] = $team_data['pickability_w'];
  }
  $g->set_data($a);
  $g->area_hollow( 2, 3, 25, '#800080', 'Correctly Picked To Win', 12);


  $g->set_x_labels( $x_labels );
  $g->set_x_label_style( 12, '#000000', 2);

  $g->set_x_legend( 'Percent that a team is correctly picked', 12);
  
  $g->set_y_max( 100 );
  $g->y_label_steps( 10 );
  $g->set_y_legend( 'Percent', 12);
  
  $g->set_bg_colour('0xDFFFDF');
  //echo $g->render();  
  
  $g->set_tool_tip( '#x_label# (#val#)' );

  $o = $g->render('js');
  
  if ($sort_by == 'to_win' ) {
    $o .= l('Sort By "Correctly Picked"', 'pickem/'. $league->lid .'/chart2/win_lose', array('html' => TRUE));
  } 
  else {
    $o .= l('Sort By "Correctly Picked To Win"', 'pickem/'. $league->lid .'/chart2/to_win', array('html' => TRUE));
  }
  
  print theme('page', $o); 
}

function email_warning($user, $week_id, $firstgame, $missing_picks, $league_id) {

  $headers['Content-Type'] = 'text/plain; charset=UTF-8; format=flowed';
  //$headers['Content-Type'] = 'text/html; charset=UTF-8;';

  $subject = 'NFL Pickem: Week'. $week_id .' picks due!';
  $body = "Picks Due Before: $firstgame (EST)\n\nJust a reminder, you're missing $missing_picks picks for week $week_id\n\nhttp://nfl.vandervortsweb.com/pickem/". $league_id ."/picks/". $week_id;

  $from = variable_get('pickem_commisioner_email', '');
  $headers['From'] = $from;
  $headers['Bcc'] = $from;
  
  $to = $user->name .' <'. $user->mail .'>';

  $params = array();
  $params['headers'] = $headers;
  $params['subject'] = $subject;
  $params['body'] = $body;

  // $module, $key, $to, $language, $params = array(), $from = NULL, $send = TRUE
  $message = drupal_mail('email_warning', 'notice', $to, language_default(), $params);
  if ($message['result'] == 1) {
    watchdog('pickem', $user->name .": Week $wid Warning");
  }
  else {
    watchdog('pickem', 'Error Sending '.  $user->name .": Week $wid Warning");
  }

}

/*
  implementation of hook_mail
*/
function email_warning_mail($key, &$message, $params) {
  switch ($key) {
    case 'notice':
      $message['headers'] = $params['headers'];
      $message['subject'] = $params['subject'];
      $message['body'] = $params['body'];
      break;
  }
}


// Requires the countdowntimer module
function get_countdown_timer($current_week) {

$o = <<<EOD
Reminder: Week {$current_week['wid']} picks due in
<span class="countdowntimer">
<span style="display:none" class="datetime">{$current_week['firstgame_xml']}</span>
<span style="display:none" class="format_txt">%days% days + %hours%:%mins%:%secs%(%dow%)</span>
</span>
EOD;

return $o;
}

function pickem_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      // If $op is "list", we just need to return a list of block descriptions.
      // This is used to provide a list of possible blocks to the administrator,
      // end users will not see these descriptions.
      // A block can provide default settings.
      $blocks[0] = array(
        'info'       => t('Pickem Leagues'),
        'visibility' => 1,
        'pages'      => 'pickem/*'
      );
      $blocks[1] = array(
        'info'       => t('Pickem Leaderboard'),
        'visibility' => 2,
        'pages'      => "<?php return (arg(0)=='pickem' && is_numeric(arg(1)) && arg(2)=='')?TRUE:FALSE;?>",
        'cache' => BLOCK_NO_CACHE
      );
      $blocks[2] = array(
        'info'       => t('Pickem This Weeks Games'),
        'visibility' => 2,
        'pages'      => "<?php return (arg(0)=='pickem' && is_numeric(arg(1)) && arg(2)=='')?TRUE:FALSE;?>",
        'cache' => BLOCK_NO_CACHE
      );
      return $blocks;
    case 'configure':
      // If $op is "configure", we need to provide the administrator with a
      // configuration form. The $delta parameter tells us which block is being
      // configured. In this example, we'll allow the administrator to customize
      // the text of the first block.
      $form = array();
      if ($delta == 0) {
        // All we need to provide is a text field, Drupal will take care of
        // the other block configuration options and the save button.
        //$form['block_example_string'] = array(
        //  '#type' => 'textfield',
        //  '#title' => t('Block contents'),
        //  '#size' => 60,
        //  '#description' => t('This string will appear in the example block.'),
        //  '#default_value' => variable_get('block_example_string',  t('Some example content.')),
        //);
      }
      return $form;
    case 'save':
      // If $op is "save", we need to save settings from the configuration form.
      // Since the first block is the only one that allows configuration, we
      // need to check $delta to make sure we only save it.
      //if ($delta == 0) {
        // Have Drupal save the string to the database.
      //  variable_set('block_example_string', $edit['block_example_string']);
      //}
      //return;
    case 'view': default:
      switch ($delta) {
        case 0:
          $block['subject'] = t('My Leagues');
          $block['content'] = get_my_league_switcher();
          break;
        case 1:
          $block['subject'] = t('Leaderboard');
          $block['content'] = theme('leaderboard_block', arg(1));
          break;
        case 2:
          $cur_w = get_current_week(false); 
          $block['subject'] = 'Games(week '. $cur_w['wid'] .')';
          $block['content'] = theme('this_weeks_games_block', arg(1));
      }
      return $block;
  }
}

function get_my_league_switcher() {
  $leagues = get_my_leagues();

  if ( count($leagues) < 2 ) {
    return '';
  }

  $o = '';
  $path ='';
  $list = explode('/', $_GET['q']);
  if ( count($list) > 2 ) {
    // discard first two items
    array_shift($list);
    array_shift($list);
    $path = '/'. implode('/', $list);
  }
  
  foreach ($leagues as $l) {
    if ( arg(1) == $l->lid ) {
      $o.=l('&raquo; '. $l->name, 'pickem/'. $l->lid . $path, array('html' => TRUE)) .'<br/>';
    }
    else {
      $o.=l($l->name, 'pickem/'. $l->lid . $path) .'<br/>';
    }
  }
  return $o;  
}

function get_all_league_switcher() {
  $leagues = get_leagues();
  $o = '';
  foreach ($leagues as $l) {
    if ( arg(1) == $l->lid ) {
      $o.=l('&raquo; '. $l->name, 'pickem/'. $l->lid, array('html' => TRUE)) .'<br/>';
    }
    else {
      $o.=l($l->name, 'pickem/'. $l->lid) .'<br/>';
    }
  }
  return $o;  
}


function league_access($string, $account = NULL) {
  drupal_set_message('league_access');
  
  global $user;

  if (is_null($account)) {
    $account = $user;
  }

  // Need play pickem first
  if ( user_access('play pickem', $account) == FALSE ) {
    return FALSE;
  }
  
  if ( $string == 'league access' ) {
    $leagues = get_my_leagues($account);
    foreach ($leagues as $l) {
      if ( arg(1) == $l->lid ) {
        return TRUE;
      }
    }
  }
  return FALSE;
}
